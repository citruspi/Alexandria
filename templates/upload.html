{% extends "base.html" %}

{% block content %}

    <div class="previewsContainer" style="display: none;"></div>

    <div id="notice">
        <center><h2>drag and drop an ebook here</h2><h3>(or click anywhere if you're stuck in 1995)</center>
    </div>

    <div class="row">

        <div class="large-6 columns">

            <div id="myModal" class="reveal-modal reveal-modal-small" data-reveal>

                <form onsubmit="getResults(); return false;">

                    <div class="row collapse">

                        <div class="large-10 columns">

                            <input type="text" placeholder="Search by ISBN or title" id="query">

                        </div>

                        <div class="large-2 columns">

                            <a href="#" class="button postfix">SEARCH</a>

                        </div>

                    </div>

                </form>

                <div id="results">
                <hr>

                <form onsubmit="confirmResult(); return false;" name="confirm">

                    <div class="row">
                        <div class="large-10 columns">
                            <select id="select">
                            </select>
                        </div>
                        <div class="large-2 columns">
                            <a href="#" class="button postfix" onclick="confirmResult();">CONFIRM</a>
                        </div>
                    </div>

                    <div class="row">

                        <div class="large-12 columns">

                            <dl class="accordion" data-accordion>

                                <dd>

                                    <a href="#panel1">Genres</a>

                                    <div id="panel1" class="content">

                                        <div class="row">

                                            <div class="large-3 columns">
                                                <input name="genres" type="checkbox" value="Art"><label>Art</label><br>
                                                <input name="genres" type="checkbox" value="Biography"><label>Biography</label><br>
                                                <input name="genres" type="checkbox" value="Business"><label>Business</label><br>
                                                <input name="genres" type="checkbox" value="Chick Lit"><label>Chick Lit</label><br>
                                                <input name="genres" type="checkbox" value="Children's"><label>Children's</label><br>
                                                <input name="genres" type="checkbox" value="Classics"><label>Classics</label><br>
                                                <input name="genres" type="checkbox" value="Comics"><label>Comics</label><br>
                                                <input name="genres" type="checkbox" value="Computers"><label>Computers</label><br>
                                                <input name="genres" type="checkbox" value="Contemporary"><label>Contemporary</label><br>
                                                <input name="genres" type="checkbox" value="Cookbooks"><label>Cookbooks</label><br>
                                            </div>

                                            <div class="large-3 columns">
                                                <input name="genres" type="checkbox" value="Crime"><label>Crime</label><br>
                                                <input name="genres" type="checkbox" value="Fantasy"><label>Fantasy</label><br>
                                                <input name="genres" type="checkbox" value="Fiction"><label>Fiction</label><br>
                                                <input name="genres" type="checkbox" value="Gay and Lesbian"><label>Gay and Lesbian</label><br>
                                                <input name="genres" type="checkbox" value="Graphic Novels"><label>Graphic Novels</label><br>
                                                <input name="genres" type="checkbox" value="Historical Fiction"><label>Historical Fiction</label><br>
                                                <input name="genres" type="checkbox" value="History"><label>History</label><br>
                                                <input name="genres" type="checkbox" value="Horror"><label>Horror</label><br>
                                                <input name="genres" type="checkbox" value="Humor and Comedy"><label>Humor and Comedy</label><br>
                                                <input name="genres" type="checkbox" value="Manga"><label>Manga</label><br>
                                            </div>

                                            <div class="large-3 columns">
                                                <input name="genres" type="checkbox" value="Memoirs"><label>Memoirs</label><br>
                                                <input name="genres" type="checkbox" value="Music"><label>Music</label><br>
                                                <input name="genres" type="checkbox" value="Mystery"><label>Mystery</label><br>
                                                <input name="genres" type="checkbox" value="Non Fiction"><label>Non Fiction</label><br>
                                                <input name="genres" type="checkbox" value="Other"><label>Other</label><br>
                                                <input name="genres" type="checkbox" value="Paranormal"><label>Paranormal</label><br>
                                                <input name="genres" type="checkbox" value="Philosophy"><label>Philosophy</label><br>
                                                <input name="genres" type="checkbox" value="Poetry"><label>Poetry</label><br>
                                                <input name="genres" type="checkbox" value="Psychology"><label>Psychology</label><br>
                                                <input name="genres" type="checkbox" value="Religion"><label>Religion</label><br>
                                            </div>

                                            <div class="large-3 columns">
                                                <input name="genres" type="checkbox" value="Romance"><label>Romance</label><br>
                                                <input name="genres" type="checkbox" value="Science"><label>Science</label><br>
                                                <input name="genres" type="checkbox" value="Science Fiction"><label>Science Fiction</label><br>
                                                <input name="genres" type="checkbox" value="Self Help"><label>Self Help</label><br>
                                                <input name="genres" type="checkbox" value="Suspense"><label>Suspense</label><br>
                                                <input name="genres" type="checkbox" value="Spirituality"><label>Spirituality</label><br>
                                                <input name="genres" type="checkbox" value="Sports"><label>Sports</label><br>
                                                <input name="genres" type="checkbox" value="Thriller"><label>Thriller</label><br>
                                                <input name="genres" type="checkbox" value="Travel"><label>Travel</label><br>
                                                <input name="genres" type="checkbox" value="Young Adult"><label>Young Adult</label><br>
                                            </div>
                                        </div>
                                    </div>
                                </dd>
                            </dl>
                        </div>
                    </div>

                    <br>

                    <div class="row" id="result">
                        <!-- -->
                    </div>

                </form>
                </div>

            </div>

        </div>

    </div>

    {% include "scripts.html" %}

    <script src="/static/js/flexverticalcenter.js"></script>
    <script src="/static/js/dropzone.js"></script>
    <script src="/static/js/mustache.js"></script>
    <script src="/static/js/jquery.growl.js"></script>

    <script id="template" type="x-tmpl-mustache">
        {% raw %}
        <div class="large-3 columns">
            <img src="{{ cover }}" width="100%">
        </div>
        <div class="large-9 columns">
            {{ #title }}
            <dl>
                <dt>Title</dt>
                <dd>{{ title }}</dd>
            </dl>
            {{ /title }}
            {{ #subtitle }}
            <dl>
                <dt>Subtitle</dt>
                <dd>{{ subtitle }}</dd>
            </dl>
            {{ /subtitle }}
            <dl>
                <dt>Author(s)</dt>
                {{ #authors }}
                <dd>{{ . }}</dd>
                {{ /authors }}
            </dl>
            {{ #description }}
            <dl>
                <dt>Description</dt>
                <dd>{{ description }}</dd>
            </dl>
            {{ /description }}
        </div>
        {% endraw %}
    </script>

    <script>

        window.flexVerticalCenter(document.getElementById('notice'));

        $(document.body).dropzone({
            url: "/upload",
            paramName: "file",
            clickable: true,
            previewsContainer: ".previewsContainer",
            success: function(file, response) {
                {% if setting['confirm'] %}
                document.getElementById('query').value = file.name.split('.')[0];
                getResults();
                $('#myModal').foundation('reveal', 'open');
                window.token = response['filename'];
                {% else %}
                noConfirm(response['filename'], file.name.split('.')[0]);
                {% endif %}
            }
        });

        $('#select').bind('change',function(){
            var e = document.getElementById("select");
            var value = e.options[e.selectedIndex].value;
            displayResult(value);
        });

        function noConfirm (token, query) {

            if (query != null && query != '') {

                $.getJSON( "https://www.googleapis.com/books/v1/volumes?q="+query, function( data ) {

                    $.post("/confirm/"+token+'/'+data['items'][0]['id']);

                    $.growl.notice({
                        title: "Success!",
                        message: data['items'][0].volumeInfo['title'] + " was uploaded!"
                    });


                });

            }

        }

        function listResults () {
            window.results.forEach(function(i) {

                var opt = document.createElement('option');
                opt.value = i['id'];
                opt.innerHTML = (function () {

                    var title = i.volumeInfo['title'];

                    if (i.volumeInfo['authors'] != null) {

                        title += ' - ';

                        if (i.volumeInfo['authors'].length < 2) {
                            title += i.volumeInfo['authors'][0] + ' ';
                        }

                        else {
                            i.volumeInfo['authors'].forEach(function(author) {
                                title += author + '; ';
                            });
                        }

                    }

                    if (i.volumeInfo['publishedDate'] != null) {

                        return title + '(' + i.volumeInfo['publishedDate'].substring(0,4) + ')';

                    }

                })();

                document.getElementById('select').appendChild(opt);

            });
        }

        function displayResult (id) {
            window.results.forEach(function(i){
                if (i['id'] == id){
                    var template = $('#template').html();
                    Mustache.parse(template);   // optional, speeds up future uses
                    var rendered = Mustache.render(template, {
                        title: i.volumeInfo['title'],
                        subtitle: i.volumeInfo['subtitle'],
                        authors: i.volumeInfo['authors'],
                        description: i.volumeInfo['description'],
                        "cover": function () {
                            var covers = i.volumeInfo['imageLinks'];
                            if (covers['extraLarge'] != null && covers['extraLarge'] != '') {
                                return covers['extraLarge'];
                            }
                            else if (covers['large'] != null && covers['large'] != '') {
                                return covers['large'];
                            }
                            else if (covers['medium'] != null && covers['medium'] != '') {
                                return covers['medium'];
                            }
                            else if (covers['small'] != null && covers['small'] != '') {
                                return covers['small'];
                            }
                            else if (covers['thumbnail'] != null && covers['thumbnail'] != '') {
                                return covers['thumbnail'];
                            }
                            else if (covers['smallThumbnail'] != null && covers['smallThumbnail'] != '') {
                                return covers['smallThumbnail'];
                            }
                            else {
                                return '';
                            }
                        }
                    });
                    $('#result').html(rendered);
                }
            });
        }

        $(document).on('closed', '[data-reveal]', function () {
            window.results = null;
            $("#select").empty();
            $("#result").empty();
        });

        function confirmResult() {
            var e = document.getElementById("select");
            var value = e.options[e.selectedIndex].value;

            $.post("/confirm/"+window.token+'/'+value, $( document.forms.confirm ).serialize());

            window.results.forEach(function(i){
                if (i['id'] == value){
                    $.growl.notice({
                        title: "Success!",
                        message: i.volumeInfo['title'] + " was uploaded!"
                    });
                }
            });

            $('#myModal').foundation('reveal', 'close');

            return false;
        }

        function getResults() {

            query = document.getElementById('query').value;

            if (query != null && query != '') {

                $("#select").empty();

                $.getJSON( "https://www.googleapis.com/books/v1/volumes?q="+query, function( data ) {

                    window.results = data['items'];

                    listResults();
                    displayResult(data['items'][0]['id']);


                });

            }

            return false;
        }
    </script>
{% endblock %}
